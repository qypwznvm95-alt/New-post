import asyncio
import logging
import sqlite3
from datetime import datetime
from typing import Dict, List
import aiohttp
import requests
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes
from telegram.error import TelegramError
import openai
from pathlib import Path

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
BOT_TOKEN = "YOUR_BOT_TOKEN"
OPENAI_API_KEY = "YOUR_OPENAI_API_KEY"
OPENWEATHER_API_KEY = "YOUR_WEATHER_API_KEY"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI
openai.api_key = OPENAI_API_KEY

class CarSalesBot:
    def __init__(self):
        self.db_path = "car_sales_bot.db"
        self.init_database()
        self.region_data = {}
        
    def init_database(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                first_name TEXT,
                region TEXT,
                interest_level INTEGER DEFAULT 0,
                last_contact DATE,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS sent_offers (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                offer_type TEXT,
                sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users (user_id)
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS regions (
                region_name TEXT PRIMARY KEY,
                telegram_channels TEXT,
                chat_groups TEXT,
                potential_clients INTEGER,
                analysis_data TEXT
            )
        ''')
        
        conn.commit()
        conn.close()

    async def analyze_region(self, region: str) -> Dict:
        """–ê–Ω–∞–ª–∏–∑ —Ä–µ–≥–∏–æ–Ω–∞ —Å –ø–æ–º–æ—â—å—é –ò–ò"""
        try:
            prompt = f"""
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–µ–≥–∏–æ–Ω {region} –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –∏ –æ–ø—Ä–µ–¥–µ–ª–∏:
            1. –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ Telegram –∫–∞–Ω–∞–ª—ã –∏ —á–∞—Ç—ã —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏
            2. –î–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
            3. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Å–ø—Ä–æ—Å –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏
            4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É
            
            –í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
            {{
                "telegram_channels": ["–∫–∞–Ω–∞–ª1", "–∫–∞–Ω–∞–ª2"],
                "chat_groups": ["—á–∞—Ç1", "—á–∞—Ç2"],
                "demographics": "–∞–Ω–∞–ª–∏–∑ –¥–µ–º–æ–≥—Ä–∞—Ñ–∏–∏",
                "potential_demand": "–≤—ã—Å–æ–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π/–Ω–∏–∑–∫–∏–π",
                "marketing_recommendations": "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏",
                "estimated_clients": —á–∏—Å–ª–æ
            }}
            """
            
            response = openai.ChatCompletion.create(
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                temperature=0.7
            )
            
            analysis = eval(response.choices[0].message.content)
            return analysis
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–≥–∏–æ–Ω–∞: {e}")
            return self.get_default_analysis(region)

    def get_default_analysis(self, region: str) -> Dict:
        """–†–µ–∑–µ—Ä–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–µ–≥–∏–æ–Ω–∞"""
        return {
            "telegram_channels": [f"–∞–≤—Ç–æ_{region}", f"cars_{region}"],
            "chat_groups": [f"–∫—É–ø–∏—Ç—å_–∞–≤—Ç–æ_{region}", f"–ø—Ä–æ–¥–∞–∂–∞_–∞–≤—Ç–æ_{region}"],
            "demographics": "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–µ–≥–∏–æ–Ω–∞",
            "potential_demand": "—Å—Ä–µ–¥–Ω–∏–π",
            "marketing_recommendations": "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏",
            "estimated_clients": 1000
        }

    async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
        user = update.effective_user
        keyboard = [
            [InlineKeyboardButton("üöó –ò–Ω—Ç–µ—Ä–µ—Å—É—é—Å—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏", callback_data="interest_cars")],
            [InlineKeyboardButton("üìä –ê–Ω–∞–ª–∏–∑ —Ä–µ–≥–∏–æ–Ω–∞", callback_data="analyze_region")],
            [InlineKeyboardButton("üìÑ –ü–æ–ª—É—á–∏—Ç—å –ö–ü", callback_data="get_offer")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(
            f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.first_name}!\n"
            "–Ø –±–æ—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π —Ä–µ–≥–∏–æ–Ω–æ–≤.",
            reply_markup=reply_markup
        )

    async def handle_interest(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞ –∫ –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º"""
        query = update.callback_query
        await query.answer()
        
        user_id = query.from_user.id
        user_data = self.get_user_data(user_id)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –ª–∏ —É–∂–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
        if not self.has_received_offer(user_id):
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º PDF –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
            await self.send_offer_pdf(user_id, context)
            # –û—Ç–º–µ—á–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É
            self.mark_offer_sent(user_id, "car_offer")
            
            await query.edit_message_text(
                "‚úÖ –ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!\n"
                "–°–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π."
            )
        else:
            await query.edit_message_text(
                "‚ö†Ô∏è –í—ã —É–∂–µ –ø–æ–ª—É—á–∞–ª–∏ –Ω–∞—à–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.\n"
                "–î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º."
            )

    async def handle_region_analysis(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ê–Ω–∞–ª–∏–∑ —Ä–µ–≥–∏–æ–Ω–∞"""
        query = update.callback_query
        await query.answer()
        
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–µ–≥–∏–æ–Ω
        await query.edit_message_text(
            "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:\n"
            "(–Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞, –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π)"
        )
        context.user_data['waiting_for_region'] = True

    async def handle_region_input(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ä–µ–≥–∏–æ–Ω–∞"""
        if context.user_data.get('waiting_for_region'):
            region = update.message.text
            user_id = update.effective_user.id
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–≥–∏–æ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            self.save_user_region(user_id, region)
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑
            analysis_msg = await update.message.reply_text(
                f"üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ä–µ–≥–∏–æ–Ω {region}...\n"
                "–≠—Ç–æ –∑–∞–π–º–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥."
            )
            
            # –ü–æ–ª—É—á–∞–µ–º –∞–Ω–∞–ª–∏–∑ –æ—Ç –ò–ò
            analysis = await self.analyze_region(region)
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            response = self.format_analysis_response(region, analysis)
            
            await analysis_msg.edit_text(response)

    def format_analysis_response(self, region: str, analysis: Dict) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞"""
        channels = "\n".join([f"‚Ä¢ {ch}" for ch in analysis['telegram_channels'][:5]])
        groups = "\n".join([f"‚Ä¢ {gr}" for gr in analysis['chat_groups'][:5]])
        
        return (
            f"üìä –ê–Ω–∞–ª–∏–∑ —Ä–µ–≥–∏–æ–Ω–∞: {region}\n\n"
            f"üìà –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Å–ø—Ä–æ—Å: {analysis['potential_demand'].upper()}\n"
            f"üë• –û—Ü–µ–Ω–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤: {analysis['estimated_clients']}\n\n"
            f"üì¢ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∫–∞–Ω–∞–ª—ã:\n{channels}\n\n"
            f"üí¨ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —á–∞—Ç—ã:\n{groups}\n\n"
            f"üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n{analysis['marketing_recommendations']}"
        )

    async def send_offer_pdf(self, user_id: int, context: ContextTypes.DEFAULT_TYPE):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ PDF –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è"""
        try:
            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ PDF
            pdf_path = await self.generate_offer_pdf(user_id)
            
            # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞
            await context.bot.send_document(
                chat_id=user_id,
                document=open(pdf_path, 'rb'),
                caption="üöó –í–∞—à–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º\n\n"
                       "–°–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è!"
            )
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ PDF: {e}")
            await context.bot.send_message(
                chat_id=user_id,
                text="–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è."
            )

    async def generate_offer_pdf(self, user_id: int) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–∑–∞–≥–ª—É—à–∫–∞)"""
        # –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—è PDF
        # –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É like reportlab –∏–ª–∏ weasyprint
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π PDF –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω
        pdf_path = "car_offer_template.pdf"
        
        # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
        if not Path(pdf_path).exists():
            self.create_sample_pdf(pdf_path)
            
        return pdf_path

    def create_sample_pdf(self, path: str):
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–∞ PDF (–∑–∞–≥–ª—É—à–∫–∞)"""
        from reportlab.lib.pagesizes import A4
        from reportlab.pdfgen import canvas
        
        c = canvas.Canvas(path, pagesize=A4)
        c.drawString(100, 750, "–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ")
        c.drawString(100, 730, "–ü–æ –ø—Ä–æ–¥–∞–∂–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π")
        c.drawString(100, 710, "–ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –≤ –Ω–∞–ª–∏—á–∏–∏")
        c.save()

    # –ú–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
    def get_user_data(self, user_id: int) -> Dict:
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
        result = cursor.fetchone()
        conn.close()
        
        if result:
            return {
                'user_id': result[0],
                'username': result[1],
                'first_name': result[2],
                'region': result[3],
                'interest_level': result[4],
                'last_contact': result[5]
            }
        return {}

    def save_user_region(self, user_id: int, region: str):
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute('''
            INSERT OR REPLACE INTO users (user_id, region, last_contact)
            VALUES (?, ?, CURRENT_TIMESTAMP)
        ''', (user_id, region))
        conn.commit()
        conn.close()

    def has_received_offer(self, user_id: int) -> bool:
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute("SELECT 1 FROM sent_offers WHERE user_id = ?", (user_id,))
        result = cursor.fetchone()
        conn.close()
        return result is not None

    def mark_offer_sent(self, user_id: int, offer_type: str):
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute(
            "INSERT INTO sent_offers (user_id, offer_type) VALUES (?, ?)",
            (user_id, offer_type)
        )
        conn.commit()
        conn.close()

    async def button_handler(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –∫–Ω–æ–ø–æ–∫"""
        query = update.callback_query
        data = query.data
        
        if data == "interest_cars":
            await self.handle_interest(update, context)
        elif data == "analyze_region":
            await self.handle_region_analysis(update, context)
        elif data == "get_offer":
            await self.handle_interest(update, context)

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    bot = CarSalesBot()
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(BOT_TOKEN).build()
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    application.add_handler(CommandHandler("start", bot.start))
    application.add_handler(CallbackQueryHandler(bot.button_handler))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, bot.handle_region_input))
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    application.run_polling()

if __name__ == "__main__":
    main()
